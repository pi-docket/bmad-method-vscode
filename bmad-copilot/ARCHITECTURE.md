# BMAD Copilot Adapter — Architecture Document

> **Version**: 0.2.4  
> **BMAD-METHOD Compatibility**: ≥ 6.0.0-Beta.1  
> **VS Code Engine**: ≥ 1.93.0  
> **Last updated**: 2026-02

---

## 1. Design Philosophy

This extension is a **pure read-only adapter** — an Official BMAD GitHub
Copilot Prompt Executor.

It is **not** a CLI runtime, **not** a workflow engine, **not** a prompt
pre-processor, and **not** a file generator. It reads the official
`.prompt.md` / `bmad-agent-*.md` files generated by `npx bmad-method install
--tools github-copilot` and passes them directly to the Copilot LLM — the
same files that native GitHub Copilot Chat would consume.

### What This Extension Does

- Registers the `@bmad` chat participant with slash commands
- Discovers and indexes available BMAD commands from `_bmad/_config/` CSVs
- Maps command names to `.github/prompts/*.prompt.md` and `.github/agents/bmad-agent-*.md`
- Reads the prompt file content and sends it to the Copilot LLM **as-is**
- Spawns the real BMAD CLI for `install` operations

### What This Extension Does **NOT** Do

- ❌ Pre-read or inline `{project-root}` file references — the LLM reads workspace files itself
- ❌ Parse, rewrite, or transform official prompt file content
- ❌ Mirror, convert, or generate prompt files from other IDE formats
- ❌ Manage token budgets or truncate prompts
- ❌ Merge configs or resolve YAML/XML workflows programmatically
- ❌ Replicate BMAD CLI execution logic
- ❌ Modify any file in `_bmad/` directory (read-only access)
- ❌ Create or overwrite files in `.github/prompts/` or `.github/agents/`

### Why Not Inline?

Official BMAD `.prompt.md` files contain instructions like:

```
Read the file at {project-root}/_bmad/bmm/config.yaml
```

GitHub Copilot's native prompt system resolves `{project-root}` and
gives the LLM access to workspace files. When the extension sends these
prompts via `request.model.sendRequest()`, the LLM can still access
workspace files through its context. Pre-reading and inlining these
files would duplicate content, waste tokens, and diverge from the
official BMAD prompt design.

> **Note:** `request.model.sendRequest()` may not fully resolve
> `{project-root}` references in all cases. This is a known limitation
> of the Chat Participant API vs. native Copilot prompt files. The
> official prompts are still passed unmodified — the LLM does its best
> with the workspace context available.

---

## 2. Overview

```
┌─────────────────────────────────────────────────┐
│              VS Code Copilot Chat                │
│                                                  │
│   User types:  @bmad /run bmad-bmm-create-prd   │
└──────────────────────┬──────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│  extension.ts  — Activation & Lifecycle          │
│  ┌────────────────────────────────────────────┐  │
│  │  chatBridge.ts  — Prompt Executor          │  │
│  │  ┌──────────────────────────────────────┐  │  │
│  │  │  commandRegistry.ts — Command Index  │  │  │
│  │  │  cliBridge.ts — CLI Process Spawner  │  │  │
│  │  └──────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────┘
                       │
                       ▼
              ┌─────────────────┐
              │  Copilot LLM    │
              │  (User's model) │
              └─────────────────┘
```

---

## 3. Module Architecture

### `extension.ts` — Lifecycle

| Responsibility  | Detail                                                                                 |
| --------------- | -------------------------------------------------------------------------------------- |
| Activation      | Triggered by `onChatParticipant:bmad` or `onStartupFinished`                           |
| Participant     | Registers `@bmad` via `vscode.chat.createChatParticipant()`                            |
| Initial Scan    | Calls `CommandRegistry.scan()` at activation                                           |
| Integrity Check | Warns if `_bmad/` exists but `.github/prompts/` and `.github/agents/` are both missing |
| File Watchers   | Monitors `_bmad/**`, `.github/prompts/**`, `.github/agents/**`                         |
| Configuration   | Reacts to `bmad.*` setting changes                                                     |
| Commands        | Provides `rescan`, `update`, and `install` VS Code commands                            |

### `chatBridge.ts` — Prompt Executor (Core)

| Responsibility        | Detail                                                                                              |
| --------------------- | --------------------------------------------------------------------------------------------------- |
| Routing               | Maps slash commands (`/help`, `/run`, `/agents`, etc.) to handlers                                  |
| Prompt File Execution | Reads `.prompt.md` / `.agent.md` → strips frontmatter → sends raw prompt to LLM (no ref resolution) |
| CLI Delegation        | Delegates `/install` to `CliBridge.openTerminal()`                                                  |
| Free-text             | Fuzzy-matches user input to known commands                                                          |
| LLM Streaming         | Calls `request.model.sendRequest()` and streams fragments                                           |

### `commandRegistry.ts` — Command Index

| Responsibility      | Detail                                                                   |
| ------------------- | ------------------------------------------------------------------------ |
| Discovery           | Finds `_bmad/` directory and enumerates modules                          |
| CSV Parsing         | Zero-dependency parser for 5 manifest CSVs (with UTF-8 BOM stripping)    |
| Prompt File Mapping | Scans `.github/prompts/` and `.github/agents/` to link files to commands |
| Name Conversion     | `cliToSlash()` / `slashToCli()` bidirectional mapping                    |
| Fuzzy Search        | Case-insensitive substring matching across names/descriptions            |
| Invalidation        | `invalidate()` clears cache; `rescan()` combines invalidate + scan       |

### `cliBridge.ts` — CLI Process Spawner

| Responsibility | Detail                                                     |
| -------------- | ---------------------------------------------------------- |
| Terminal       | Opens VS Code terminal with `npx bmad-method install`      |
| Detection      | Checks for `_bmad/`, `.github/prompts/`, `.github/agents/` |
| Version        | Queries `npx bmad-method --version`                        |

### `promptMirror.ts` — DEPRECATED

| Responsibility | Detail                                                         |
| -------------- | -------------------------------------------------------------- |
| **Status**     | **@deprecated** — not imported by any active module            |
| Original Role  | Mirrored claude-code prompts to Copilot format                 |
| Current Role   | Historical reference only; will be removed in a future version |

### `bmadRuntime.ts` — DEPRECATED

| Responsibility | Detail                                                         |
| -------------- | -------------------------------------------------------------- |
| **Status**     | **@deprecated** — not imported by any active module            |
| Original Role  | Built prompts directly from `_bmad/` manifests as a fallback   |
| Current Role   | Historical reference only; will be removed in a future version |

---

## 4. CLI Bootstrap Layer

The adapter ships a CLI entry point at `bin/bmad-copilot-adapter.js` that
provides three commands for terminal-based project setup:

| Command     | Module              | Purpose                                             |
| ----------- | ------------------- | --------------------------------------------------- |
| `bootstrap` | `src/cli/bootstrap` | Full setup: check Node, detect prompts, install ext |
| `update`    | `src/cli/update`    | Rescan prompts, write sentinel, print summary       |
| `status`    | `src/cli/status`    | Show full installation diagnostics                  |

```bash
npx bmad-copilot-adapter bootstrap   # first-time project setup
npx bmad-copilot-adapter update      # after re-running bmad-method install
npx bmad-copilot-adapter status      # diagnose problems
```

The CLI is a **diagnostic and setup tool only** — it never modifies prompt
files, never invokes mirroring logic, and never writes to `.github/`.

---

## 5. Data Flow — `/run bmad-bmm-create-prd`

```
User: @bmad /run bmad-bmm-create-prd
  │
  ▼
extension.ts
  │ chatBridge.handler(request, context, stream, token)
  ▼
chatBridge.ts :: handleRun()
  │ parts = ["bmad-bmm-create-prd"]
  │ command = registry.resolve("bmad-bmm-create-prd")
  ▼
chatBridge.ts :: executeCommand()
  │ promptFilePath = .github/prompts/bmad-bmm-create-prd.prompt.md
  │ exists? → YES
  ▼
chatBridge.ts :: buildFromPromptFile()
  │ 1. Read raw file content
  │ 2. Strip YAML frontmatter (---...---)
  │ 3. Append user input (if any)
  │ 4. Return body AS-IS (no inline, no file resolution)
  ▼
chatBridge.ts :: sendToLlm(prompt, request, stream, token)
  │ messages = [LanguageModelChatMessage.User(prompt)]
  │ chatResponse = request.model.sendRequest(messages, {}, token)
  │ for await (fragment of chatResponse.text)
  │   stream.markdown(fragment)
  ▼
User sees streamed response
```

### Missing Prompt File Path

```
chatBridge.ts :: executeCommand()
  │ promptFilePath found? → NO
  │ → Show ⚠️ error with guidance:
  │   "Run: npx bmad-method install --tools github-copilot --yes"
```

---

## 6. Command Naming Convention

### CLI ↔ Slash Conversion

| CLI Syntax               | Slash Syntax             | Category        |
| ------------------------ | ------------------------ | --------------- |
| `bmad:agent:bmm:pm`      | `bmad-agent-bmm-pm`      | Agent           |
| `bmad:bmm:create-prd`    | `bmad-bmm-create-prd`    | Module Workflow |
| `bmad:help`              | `bmad-help`              | Core Task       |
| `bmad:create-next-story` | `bmad-create-next-story` | Core Workflow   |

**Rule**: CLI→Slash: replace all `:` with `-`. Slash→CLI: structural
dashes only are converted back to `:` (see `slashToCli()` in
`commandRegistry.ts` for the heuristic).
---

## 7. Static Slash Commands (VS Code Limitation)

The VS Code Chat Participant API **does not support dynamic slash command
registration**. All commands must be declared statically in `package.json`.

We declare **8 static gateway commands** that delegate to the dynamic
registry at runtime:

| Static Command | Mode            | Behaviour                                  |
| -------------- | --------------- | ------------------------------------------ |
| `/install`     | CLI Bridge      | Opens terminal → `npx bmad-method install` |
| `/status`      | Built-in + CLI  | Shows installation health table            |
| `/update`      | Built-in        | Invalidate + rescan command registry       |
| `/help`        | Built-in        | Lists commands + optional LLM help         |
| `/run <name>`  | Prompt Executor | Reads `.prompt.md` / `.agent.md` → LLM     |
| `/agents`      | Built-in        | Lists installed agents                     |
| `/workflows`   | Built-in        | Lists installed workflows                  |
| `/tasks`       | Built-in        | Lists installed tasks and tools            |

### Free-text Fallback

When the user types to `@bmad` without a slash command:

1. If input starts with `bmad-`, attempt exact command match → execute.
2. Otherwise, inject BMAD context and forward to LLM as free chat.

---

## 8. Risk Analysis

### High Priority

| Risk                          | Impact                                                               | Mitigation                                              |
| ----------------------------- | -------------------------------------------------------------------- | ------------------------------------------------------- |
| **Static command limitation** | Cannot register individual slash commands                            | Hybrid `/run <name>` gateway + fuzzy free-text matching |
| **LLM context scope**         | `sendRequest()` may not resolve `{project-root}` like native Copilot | Documented limitation; prompts passed unmodified        |
| **BMAD version drift**        | CSV schema changes may break parsing                                 | Defensive parsing with fallback defaults                |
| **Config file exposure**      | `config.yaml` content is sent to LLM; may leak sensitive data        | **Never store secrets in config files**; use env vars   |

### Medium Priority

| Risk                          | Impact                                        | Mitigation                           |
| ----------------------------- | --------------------------------------------- | ------------------------------------ |
| **Prompt fidelity**           | LLM interpretation differs from CLI execution | Pass official prompts unmodified     |
| **Race conditions on rescan** | Rapid file changes trigger multiple scans     | Debounce timer (2 s); scan is atomic |
| **Multi-root workspaces**     | Extension only reads first workspace folder   | Document limitation                  |

### Low Priority

| Risk                     | Impact                                           | Mitigation                        |
| ------------------------ | ------------------------------------------------ | --------------------------------- |
| **No offline LLM**       | Requires Copilot + internet                      | Not solvable at this layer        |
| **Missing prompt files** | `--tools github-copilot` not used during install | Clear error with install guidance |

---

## 9. File Manifest

| File                     | Purpose                                        | Status          |
| ------------------------ | ---------------------------------------------- | --------------- |
| `src/extension.ts`       | Activation, watchers, participant registration | Active          |
| `src/chatBridge.ts`      | Prompt executor, slash command routing         | Active (core)   |
| `src/commandRegistry.ts` | CSV scanning, prompt file mapping              | Active          |
| `src/cliBridge.ts`       | CLI process spawner (`install`)                | Active          |
| `src/cli/index.ts`       | CLI router (argv parsing)                      | Active          |
| `src/cli/bootstrap.ts`   | CLI bootstrap command                          | Active          |
| `src/cli/update.ts`      | CLI update command                             | Active          |
| `src/cli/status.ts`      | CLI status command                             | Active          |
| `src/types.ts`           | Shared interfaces and types                    | Active          |
| `src/promptMirror.ts`    | Historical claude-code mirror                  | **@deprecated** |
| `src/bmadRuntime.ts`     | Legacy prompt builder from `_bmad/` manifests  | **@deprecated** |
| `package.json`           | Extension manifest                             | Active          |
| `tsconfig.json`          | TypeScript configuration                       | Active          |

---

## 10. Security Best Practices

⚠️ **Configuration File Security**

The extension reads BMAD configuration files (`_bmad/*/config.yaml`) and
includes their content in prompts sent to the GitHub Copilot LLM. This is
necessary for the LLM to understand project-specific settings and variables.

**Important Guidelines:**

1. **Never store sensitive data** in BMAD config files:
   - ❌ API keys, tokens, passwords
   - ❌ Database credentials
   - ❌ Private keys or certificates
   - ❌ Personal identifiable information (PII)

2. **Use environment variables** for secrets:

   ```yaml
   # ✅ Good - reference environment variables
   api_endpoint: "https://api.example.com"
   auth_method: "env:API_TOKEN"

   # ❌ Bad - hardcoded secrets
   api_key: "sk-1234567890abcdef"
   ```

3. **Config file scope:**
   - The extension sends full `config.yaml` content to the LLM
   - Status commands include 500-char excerpts from each module config
   - Assume all config content is visible to the AI model

4. **Recommended practices:**
   - Store only non-sensitive configuration: file paths, flags, workflow settings
   - Use `.gitignore` to exclude any local config overrides
   - Review config files before committing to version control

---

## 11. Future Roadmap

1. **Multi-root workspace support** — scan all workspace folders.
2. **Follow-up message handling** — maintain conversation state per command.
3. **Proposed API migration** — when VS Code supports dynamic slash
   commands, auto-register all discovered commands.
4. **Testing harness** — unit tests for CSV parsing and command resolution.
5. **Remove deprecated modules** — delete `promptMirror.ts` and `bmadRuntime.ts`.
